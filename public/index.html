<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>


    <link rel="stylesheet" href="style.css" type="text/css" >
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>
<body>
    
    <div id="editor">
        <textarea name="texto" id="textArea" cols="30" rows="10" v-model='editor'>
        </textarea>
        <div id="preview" v-html="preview"></div>
    </div>
    <button class="btn btn-primary mt-2 ml-2" onclick="gerar_pdf()">Imprimir</button>
<script src="script.js"></script>
<script type="text/javascript">

    let socket = io('https://projeto-websocket.herokuapp.com/' ||`http://localhost:3000`);
    
    $('#textArea').keyup( event => {
        menssage = $('#textArea').val()
        let messageObject = {
            message: menssage,
            position: $('#textArea').getCursorPosition()
        }
        socket.emit('sendMessage', messageObject)
    });

    socket.on('receiveMessage', menssage => {
        $('#preview').html(menssage.markdow)
        $('#textArea').val(menssage.texto_normal)
    });

    socket.on('output-messages', menssage => {
        if(menssage){
            $('#textArea').val(menssage.texto_normal)
            $('#preview').html(menssage.markdow)
        }else{
            $('#textArea').text("")
            $('#preview').text("")
        }
    });

    socket.on('position', pos =>{
        $('#textArea').append('|',pos)
    });

    let count = 0;
    setInterval(() => {
        let pos = $('#textArea').getCursorPosition()
        socket.volatile.emit("ping", pos);
    }, 1000);

    function gerar_pdf(){
        let dados = $('#preview').html()

        let pdf = window.open('','','');
        pdf.document.write('<html><head>');
        pdf.document.write('<title>PDF</title></head>');
        pdf.document.write('<body>');
        pdf.document.write(dados);
        pdf.document.write('</body></html>');
        pdf.document.close();
        pdf.print();
    }

    (function ($, undefined) {
    $.fn.getCursorPosition = function() {
        var el = $(this).get(0);
        var pos = 0;
        if('selectionStart' in el) {
            pos = el.selectionStart;
        } else if('selection' in document) {
            el.focus();
            var Sel = document.selection.createRange();
            var SelLength = document.selection.createRange().text.length;
            Sel.moveStart('character', -el.value.length);
            pos = Sel.text.length - SelLength;
        }
        return pos;
    }
    })(jQuery);   

    $.fn.selectRange = function(start, end) {
    if(end === undefined) {
        end = start;
    }
    return this.each(function() {
        if('selectionStart' in this) {
            this.selectionStart = start;
            this.selectionEnd = end;
        } else if(this.setSelectionRange) {
            this.setSelectionRange(start, end);
        } else if(this.createTextRange) {
            var range = this.createTextRange();
            range.collapse(true);
            range.moveEnd('character', end);
            range.moveStart('character', start);
            range.select();
        }
    });
};

</script>
</body>
</html>